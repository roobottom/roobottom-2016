{% macro grid(columns,modifier,classes) %}
  <div class="grid{% if modifier %} grid--{{modifier}}{% endif %}{% if classes %} {{classes}}{% endif %}">
  {% for column in columns %}
    <div class="grid__column">
      {{ column }}
    </div>
  {% endfor %}
  </div>
{% endmacro %}

{% macro icon(name) %}
  <svg class="icon icon--{{name}}" aria-hidden="true">
    <use xlink:href="/icons.svg#{{name}}"/>
  </svg>
{% endmacro %}

{% macro c_siteBody(content) %}
  <main class="c_siteBody">
    {% for item in content %}
        {{ item }}
    {% endfor %}
  </main>
{% endmacro %}

{% macro c_block(items,pattern) %}
  {% if pattern %}
    {% for item in items %}
      {{ pattern(item) }}
    {% endfor %}
  {% else %}
    {% for item in items %}
      {{ item }}
    {% endfor %}
  {% endif %}
{% endmacro %}

{% macro c_siteHeader(items,active) %}
  <header class="c_siteHeader {% if active %}c_siteHeader--{{active}}{% endif %}">
    {% for item in items %}
    {{item}}
    {% endfor %}
  </header>
{% endmacro %}

{% macro c_wrapper(modules) %}
  <div class="c_wrapper">
    {% for module in modules %}
      {{ module }}
    {% endfor %}
  </div>
{% endmacro %}

{% macro m_cacheItem(post) %}
  <div class="m_cacheItem m_cacheItem--{{post.attributes.type}}">
    <h3>{{post.attributes.title}}</h3>
    <p><em>{{post.attributes.type}}</em>, <time datetime="{{post.attributes.date}}">{{post.attributes.date|date}}</time></p>
  </div>
{% endmacro %}

{% macro m_figure(images,type) %}
  <figure class="m_figure{% if images|length > 1 %} m_figure--gallery{% endif %}">
    {% for i in images %}
      {% if images|length == 1 or (i.width and i.height) %}
        {% set w = '800' %}
        {% set h = 'auto' %}
      {% else %}
        {% set w = '600' %}
        {% set h = '600' %}
      {% endif %}
      <img src="{{site.imageServer}}r/{{w}}/{{h}}/{{type}}/{{i.image}}" class="m_figure__image" alt="{{i.caption}}" {% if i.width %}data-width="{{i.width}}"{% endif %} {% if i.height %}data-height="{{i.height}}"{% endif %}/>
      {% if i.caption and loop.last %}
      <figcaption class="m_figure__caption">{{i.caption}}</figcaption>
      {% endif %}
    {% endfor %}
  </figure>
{% endmacro %}

{% macro m_filmstrip(posts) %}
  <div class="m_filmstrip">
  {% for post in posts %}
      {% if post.attributes.images %}
        {% for image in post.attributes.images %}
          {% if loop.first %}
            <a href="/{{post.attributes.type}}/{{post.attributes.id}}" class="m_filmstrip__link" title="{{post.attributes.title}}">
              <img src="{{site.imageServer}}r/80/80/{{post.attributes.type}}/{{image.image}}" alt="{{post.attributes.title}}" class="m_filmstrip__images"/>
            </a>
          {% endif %}
        {% endfor %}
      {% endif %}
  {% endfor %}
  </div>
{% endmacro %}

{% macro m_gallery(images,type) %}
    <div class="m_gallery">
        {% for i in images %}
          <figure class="m_gallery__figure">
            <img src="{{site.imageServer}}r/600/auto/{{type}}/{{ i.image }}" class="m_gallery__image" {% if i.width %}data-width="{{i.width}}"{% endif %} {% if i.height %}data-height="{{i.height}}"{% endif %}/>
          </figure>
        {% endfor %}
    </div>
{% endmacro %}

{% macro m_introduction(markdownFile) %}
  <div class="m_introduction">
    {% markdown markdownFile %}
  </div>
{% endmacro %}

{% macro m_libraryBlock(text,markdown) %}
  <div class="m_libraryBlock type{% if markdown %} m_libraryBlock--markdown{% endif %}">
    {% if markdown %}
      {% markdown %}
      {{text}}
      {% endmarkdown %}
    {% else %}
      {{text}}
    {% endif %}
  </div>
{% endmacro %}

{% macro m_libraryDescription(text,markdown=true) %}
  {{text|dump|e}}
  {% if markdown == true %}
    <div class="m_libraryDescription type">
      {% markdown -%}{{text|e}}{%- endmarkdown %}
    </div>
  {% else %}
    <div class="m_libraryDescription">
      {{text}}
    </div>
  {% endif %}
{% endmacro %}

{% import "./icons/icon.pattern" as icon %}
{% macro m_logo() %}
  <a href="/" class="m_logo" aria-label="Website logo">
    {{icon.icon('logo')}}
  </a>
{% endmacro %}

{% macro m_navigation(items, active, modifier, classes) %}
<nav class="m_navigation{%if modifier %} m_navigation--{{modifier}}{% endif %}{%if classes %} {{classes}}{% endif %}">
    <ul class="m_navigation__items">
        {% for item in items -%}
        <li class="m_navigation__item{% if item.url == '/' %} m_navigation__item--homepage{% endif %}">
          <a href="{{item.url}}" class="m_navigation__link m_navigation__link--{{item.name|lower|replace(' ','-')}}{% if item.name|lower|replace(' ','-') == active %} m_navigation__link--is-active{% endif %}">
            {% if item.url == '/' -%}
              <svg class="m_navigation__logo" aria-hidden="true">
                <use xlink:href="/icons.svg#logo"/>
              </svg>
            {% else %}
              {{item.name|capitalize}}
            {%- endif %}
          </a>
        </li>
        {%- endfor %}
    </ul>
</nav>
{% endmacro %}

{% macro m_pageTitle(title,date) %}
<h1 class="m_pageTitle">{{title}}</h1>
{% if date %}
<time datetime="{{date}}" class="m_pageTitle__date">{{date | date}}</time>
{% endif %}
{% endmacro %}

{% macro m_pagination(baseUrl,pagination) %}
  <ol class="m_pagination">
    {% for page in pagination %}
    <li class="m_pagination__item">
      <a href="{{baseUrl}}{{page.url}}" class="m_pagination__link{% if page.current==true %} m_pagination__link--current{% endif %}">{{page.title}}</a>
    </li>
    {% endfor %}
  </ol>
{% endmacro %}

{% macro m_patternBlock(description,code) %}
  <div class="m_patternBlock m_patternBlock--note">
    <div class="m_patternBlock__description">{{description}}</div>
    <div class="m_patternBlock__code">{{code}}</div>
  </div>
{% endmacro %}

{% macro m_postArticle(post) %}
  <article class="m_post m_post--article">
    <div class="m_post__body type">
        {{post.html_body | safe }}
    </div>
  </article>
{% endmacro %}

{% macro m_postGallery(post) %}
  <article class="m_post m_post--gallery">
    <div class="m_post__gallery">
      {{ m_gallery(post.attributes.images,'gallery') }}
    </div>
    <div class="m_post__body type">
      {{post.html_body}}
    </div>
  </article>
{% endmacro %}

{% macro m_postNote(post) %}
  <article class="m_post m_post--note">
    {% if post.attributes.images %}
      <div class="m_post__gallery">
        {% for image in post.attributes.images %}
          {{ m_figure([image],'notes')}}
        {% endfor %}
      </div>
    {% endif %}
    <div class="m_post__body type">
      {{post.html_body}}
    </div>
  </article>
{% endmacro %}

{% macro m_posts (posts,heading="h2",link=true,limit=10) %}
  {% for post in posts|limitTo(limit) %}
    {% if post.attributes.type == 'articles' %}
      {{ m_postarticles (post,heading,link) }}
    {% endif %}
    {% if post.attributes.type == 'gallery' %}
      {{ m_postGallery (post) }}
    {% endif %}
    {% if post.attributes.type == 'notes' %}
      {{ m_postNote(post) }}
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro m_postArticlesSummary (posts,heading="h2",link=true,limit=10) %}
  {% for post in posts | filterByType('articles') | limitTo(limit) %}
      {{ m_postArticles (post,heading,link,true) }}
  {% endfor %}
{% endmacro %}

{% macro m_postNotesSummary (posts,heading="h2",link=true,limit=10) %}
  {% for post in posts | filterByType('notes') | limitTo(limit) %}
      {{ m_postNote (post,heading,link) }}
  {% endfor %}
{% endmacro %}

{% macro m_postGallerySummary (posts,heading="h2",link=true,limit=10) %}
  {% for post in posts | filterByType('gallery') | limitTo(limit) %}
      {{ m_postGallery (post) }}
  {% endfor %}
{% endmacro %}

{% macro m_prevNext(post) %}
<nav class="m_prevNext">
  {% if post.prev %}
    <div class="m_prevNext__item m_prevNext__item--prev">
      <p class="m_prevNext__label">&lArr; Previous {{post.attributes.type|singular}}</p>
      <a class="m_prevNext__link" href="/{{post.attributes.type}}/{{post.prev.id}}">{{post.prev.title}}</a>
      <time class="m_prevNext__date" datetime="{{post.prev.date}}" >{{ post.prev.date|fuzzyDate(post.attributes.date) }} previously</time>
    </div>
  {% endif %}
  {% if post.next %}
    <div class="m_prevNext__item m_prevNext__item--next">
      <p class="m_prevNext__label">Next {{post.attributes.type|singular}} &rArr;</p>
      <a class="m_prevNext__link" href="/{{post.attributes.type}}/{{post.next.id}}">{{post.next.title}}</a>
      <time class="m_prevNext__date" datetime="{{post.next.date}}" >{{ post.next.date|fuzzyDate(post.attributes.date) }} later</time>
    </div>
  {% endif %}
</nav>
{% endmacro %}

{% macro m_teaser(posts,hLevel='2',classes) %}
  {% for post in posts %}
  <article class="m_teaser m_teaser--{{post.attributes.type|singular}}{% if classes %} {{classes}}{% endif %}">
    <header class="m_teaser__header">
      <h{{hLevel}} class="m_teaser__title"><a href="/{{post.attributes.type}}/{{post.attributes.id}}" class="m_teaser__link">{{post.attributes.title|fixOrphans}}</a></h{{hLevel}}>
      <p class="m_teaser__meta">
        <time class="m_teaser__date" datetime="{{post.attributes.date}}">{{post.attributes.date|date}}</time>
        &mdash; <span class="m_teaser__word-count">{{post.html_body|wordcount}} words</span>
        {% if post.attributes.images|length > 0 %} and <span class="m_teaser__image-count">{{post.attributes.images|length}} image{% if post.attributes.images|length > 1 %}s{% endif %}</span>{% endif %}
      </p>
    </header>
    {% if post.attributes.images %}
      {% for image in post.attributes.images %}
        {% if loop.first %}
          <a href="/{{post.attributes.type}}/{{post.attributes.id}}" class="m_teaser__imageLink">
            <img src="{{site.imageServer}}r/900/auto/{{post.attributes.type}}/{{image.image}}" alt="{{post.attributes.title}}" class="m_teaser__image"/>
          </a>
        {% endif %}
      {% endfor %}
    {% endif %}
    <div class="m_teaser__description">
      <div class="m_teaser__summary type">
        <p>{{post.html_body  | striptags | truncate(200) }} <a href="/{{post.attributes.type}}/{{post.attributes.id}}">See the rest of this {{post.attributes.type|singular}}</a></p>
        <hr/>
      </div>
    </div>
  </article>
  {% endfor %}
{% endmacro %}
